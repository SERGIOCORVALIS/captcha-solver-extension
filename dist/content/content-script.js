const __chunk_0 = (function(){var e=(e=>(e.RECAPTCHA_V2="recaptcha_v2",e.RECAPTCHA_V3="recaptcha_v3",e.HCAPTCHA="hcaptcha",e.TURNSTILE="turnstile",e.IMAGE_CAPTCHA="image_captcha",e.UNKNOWN="unknown",e))(e||{});const t={enabled:!0,autoSolve:!0,hideUI:!1,captchaTypes:{recaptchaV2:!0,recaptchaV3:!0,hcaptcha:!0,turnstile:!0,imageCaptcha:!0},apiConfig:{provider:"custom",apiKey:"JHQBCCKJJBBKJkhKUUKHOWN73987230598TGU",endpoint:"http://localhost:3001/api/solve",timeout:6e5,useLocalSolver:!1},advanced:{clickDelay:500,solveDelay:1e3,retryAttempts:3,enableLogging:!1,mouseMovement:!0,humanLikeBehavior:!0},whitelist:[],blacklist:[],statistics:{totalSolved:0,byType:{[e.RECAPTCHA_V2]:0,[e.RECAPTCHA_V3]:0,[e.HCAPTCHA]:0,[e.TURNSTILE]:0,[e.IMAGE_CAPTCHA]:0,[e.UNKNOWN]:0},lastSolved:null,errors:0}},a="extension_config",r="statistics",i="last_update";function n(){return`${chrome.runtime.id||"default-key"}-captcha-solver-2024`}function o(e){return e?function(e,t){try{const a=atob(e);let r="";for(let e=0;e<a.length;e++)r+=String.fromCharCode(a.charCodeAt(e)^t.charCodeAt(e%t.length));return r}catch{return""}}(e,n()):""}function s(e){try{return atob(e),e.length>0&&/^[A-Za-z0-9+/=]+$/.test(e)}catch{return!1}}class c{static async getConfig(){return new Promise((e,r)=>{try{if("undefined"==typeof chrome||!chrome.runtime||!chrome.runtime.id)return void r(new Error("Extension runtime is not available"));chrome.storage.sync.get(a,i=>{if(chrome.runtime.lastError){const e=chrome.runtime.lastError.message||"Unknown error";return void(e.includes("Extension context invalidated")||e.includes("message port closed")?r(new Error("Extension was reloaded. Please refresh the page.")):r(new Error(e)))}if(i[a]){const r=i[a],n={...t,...r,captchaTypes:{...t.captchaTypes,...r.captchaTypes},apiConfig:{...t.apiConfig,...r.apiConfig,apiKey:"custom"===r.apiConfig?.provider&&r.apiConfig?.apiKey!==t.apiConfig.apiKey?t.apiConfig.apiKey:r.apiConfig?.apiKey||t.apiConfig.apiKey,timeout:Math.max(r.apiConfig?.timeout??t.apiConfig?.timeout??6e5,t.apiConfig?.timeout??6e5)},advanced:{...t.advanced,...r.advanced}};n.apiConfig?.apiKey&&s(n.apiConfig.apiKey)&&(n.apiConfig.apiKey=o(n.apiConfig.apiKey)),e(n)}else e(t)})}catch(i){i instanceof Error&&(i.message.includes("Extension context invalidated")||i.message.includes("message port closed"))?r(new Error("Extension was reloaded. Please refresh the page.")):r(i)}})}static async updateConfig(e){return new Promise((r,o)=>{chrome.storage.sync.get(a,c=>{const p=c[a]||t,h=e.apiConfig?{...e.apiConfig}:p.apiConfig;var l;h?.apiKey&&!s(h.apiKey)&&(h.apiKey=(l=h.apiKey)?function(e,t){let a="";for(let r=0;r<e.length;r++)a+=String.fromCharCode(e.charCodeAt(r)^t.charCodeAt(r%t.length));return btoa(a)}(l,n()):"");const g={...p,...e,captchaTypes:{...p.captchaTypes,...e.captchaTypes},apiConfig:h||p.apiConfig,advanced:{...p.advanced,...e.advanced}};chrome.storage.sync.set({[a]:g,[i]:Date.now()},()=>{chrome.runtime.lastError?o(chrome.runtime.lastError):r()})})})}static async getStatistics(){return new Promise(e=>{chrome.storage.sync.get([a,r],i=>{const n=i[a]||t,o=i[r]||n.statistics;e(o)})})}static async updateStatistics(e){return new Promise((t,a)=>{this.getStatistics().then(i=>{const n=e(i);chrome.storage.sync.set({[r]:n},()=>{chrome.runtime.lastError?a(chrome.runtime.lastError):t()})})})}static async resetStatistics(){return new Promise((e,i)=>{chrome.storage.sync.get(a,n=>{const o=n[a]||t;chrome.storage.sync.set({[r]:o.statistics},()=>{chrome.runtime.lastError?i(chrome.runtime.lastError):e()})})})}};
return {C: e, S: c, d: o, i: s};})();
const {C: e, S: t} = __chunk_0;
;const __chunk_1 = (function(){const e=new class{enabled=!1;logs=[];maxLogs=100;setEnabled(e){this.enabled=e}isEnabled(){return this.enabled}log(e,t,s){if(!this.enabled&&"DEBUG"===e)return;const i={level:e,message:t,timestamp:Date.now(),context:s};this.logs.push(i),this.logs.length>this.maxLogs&&this.logs.shift();const a=`[CAPTCHA Solver] [${e}]`,n=s?` ${JSON.stringify(s)}`:"";switch(e){case"DEBUG":console.debug(a,t,n);break;case"INFO":console.info(a,t,n);break;case"WARN":console.warn(a,t,n);break;case"ERROR":console.error(a,t,n)}}debug(e,t){this.log("DEBUG",e,t)}info(e,t){this.log("INFO",e,t)}warn(e,t){this.log("WARN",e,t)}error(e,t){this.log("ERROR",e,t)}getLogs(){return[...this.logs]}clearLogs(){this.logs=[]}exportLogs(){return JSON.stringify(this.logs,null,2)}};var t=(e=>(e.DETECT_CAPTCHA="DETECT_CAPTCHA",e.SOLVE_CAPTCHA="SOLVE_CAPTCHA",e.CAPTCHA_DETECTED="CAPTCHA_DETECTED",e.CAPTCHA_SOLVED="CAPTCHA_SOLVED",e.CAPTCHA_ERROR="CAPTCHA_ERROR",e.INJECT_TOKEN="INJECT_TOKEN",e.GET_CONFIG="GET_CONFIG",e.UPDATE_CONFIG="UPDATE_CONFIG",e.GET_STATISTICS="GET_STATISTICS",e.RESET_STATISTICS="RESET_STATISTICS",e.TOGGLE_ENABLED="TOGGLE_ENABLED",e.GET_STATUS="GET_STATUS",e))(t||{});async function s(e,t={}){const{maxAttempts:s=3,delay:i=1e3,backoff:a="exponential",onRetry:n}=t;let r=null;for(let l=1;l<=s;l++)try{return await e()}catch(o){if(r=o instanceof Error?o:new Error("Unknown error"),l===s)throw r;n&&n(l,r);const e="exponential"===a?i*Math.pow(2,l-1):i*l;await new Promise(t=>setTimeout(t,e))}throw r||new Error("Retry failed")}const i=new class{cache=new Map;TTL=3e4;MAX_SIZE=50;getKey(e,t){return`${e}:${t||"none"}`}get(e,t){const s=this.getKey(e,t),i=this.cache.get(s);return i?Date.now()>i.expiresAt?(this.cache.delete(s),null):(i.lastAccessed=Date.now(),this.cache.set(s,i),[i.detection]):null}set(e,t,s){if(0===t.length)return;const i=t[0],a=this.getKey(e,i.siteKey||s);if(this.cache.size>=this.MAX_SIZE&&!this.cache.has(a)){let e=null,t=1/0;for(const[s,i]of this.cache.entries())i.lastAccessed<t&&(t=i.lastAccessed,e=s);e&&this.cache.delete(e)}const n=Date.now();this.cache.set(a,{detection:i,timestamp:n,expiresAt:n+this.TTL,lastAccessed:n})}clear(){this.cache.clear()}cleanExpired(){const e=Date.now();for(const[t,s]of this.cache.entries())e>s.expiresAt&&this.cache.delete(t)}getStats(){return{size:this.cache.size,maxSize:this.MAX_SIZE,ttl:this.TTL}}},a=new class{intervals=new Map;timeouts=new Map;setInterval(e,t,s){this.clearInterval(e),this.intervals.set(e,setInterval(t,s))}setTimeout(e,t,s){this.clearTimeout(e),this.timeouts.set(e,setTimeout(()=>{t(),this.timeouts.delete(e)},s))}clearInterval(e){const t=this.intervals.get(e);t&&(clearInterval(t),this.intervals.delete(e))}clearTimeout(e){const t=this.timeouts.get(e);t&&(clearTimeout(t),this.timeouts.delete(e))}clearAll(){this.intervals.forEach(e=>clearInterval(e)),this.intervals.clear(),this.timeouts.forEach(e=>clearTimeout(e)),this.timeouts.clear()}getIntervalCount(){return this.intervals.size}getTimeoutCount(){return this.timeouts.size}};;
return {M: t, d: i, i: a, l: e, r: s};})();
const {l: n, d: o, M: i, i: a, r: c} = __chunk_1;
;class r{isApplicable(){const e=this.selectors.some(e=>{try{return null!==document.querySelector(e)}catch{return!1}}),t=this.checkIframeDomains();return e||t}checkIframeDomains(){const e=document.querySelectorAll("iframe");for(const t of e)try{const e=t.src;if(this.domains.some(t=>e.includes(t)))return!0}catch{continue}return!1}findElement(e){try{return document.querySelector(e)}catch{return null}}findElements(e){try{return Array.from(document.querySelectorAll(e))}catch{return[]}}findIframeByDomain(e){const t=document.querySelectorAll("iframe");for(const n of t)try{if(n.src.includes(e))return n}catch{continue}return null}calculateConfidence(e,t){return Math.min(e/t,1)}getSiteKey(e){return e.getAttribute("data-sitekey")||e.getAttribute("data-site-key")||e.getAttribute("sitekey")||null}}const s=".recaptcha-checkbox",l='iframe[src*="recaptcha/api2/anchor"]',d=".grecaptcha-badge",u="#recaptcha",h=".g-recaptcha",g=".hcaptcha-box",p=".h-captcha",m=".cf-turnstile",f='img[alt*="captcha"], img[alt*="CAPTCHA"]',C='input[name*="captcha"], input[id*="captcha"]',b='[class*="captcha"], [id*="captcha"]',w=["www.google.com","www.gstatic.com","www.recaptcha.net","recaptcha.google.com"],A=["hcaptcha.com","js.hcaptcha.com"],v=["challenges.cloudflare.com","cloudflare.com"];class y extends r{captchaType=e.RECAPTCHA_V2;selectors=[s,l,u,h];domains=w;async detect(){const e=this.hasRecaptchaScript(),t=this.checkIframeDomains(),n=this.selectors.some(e=>{try{return null!==document.querySelector(e)}catch{return!1}});console.log("[CAPTCHA Solver] reCAPTCHA detector:",{hasScript:e,hasIframes:t,hasSelectors:n,iframeCount:document.querySelectorAll('iframe[src*="recaptcha"]').length,allIframes:document.querySelectorAll("iframe").length}),e?console.log("[CAPTCHA Solver] reCAPTCHA script found, detecting..."):t||n?console.log("[CAPTCHA Solver] reCAPTCHA indicators found (iframes/selectors), detecting even without script..."):console.log("[CAPTCHA Solver] No reCAPTCHA indicators found (script, iframes, or selectors)");const o=await this.detectV2();if(o)return console.log("[CAPTCHA Solver] reCAPTCHA v2 detected!",{confidence:o.confidence,siteKey:o.siteKey?.substring(0,10)}),o;const i=await this.detectV3();return i?(console.log("[CAPTCHA Solver] reCAPTCHA v3 detected!",{confidence:i.confidence}),i):(console.log("[CAPTCHA Solver] No reCAPTCHA detected"),null)}async detectV2(){const t=this.findElement(s),o=this.findIframeByDomain("recaptcha/api2/anchor"),i=this.findElement(u)||this.findElement(h);let a=null;i||(a=document.querySelector("[data-sitekey]"));const c=document.querySelectorAll("iframe"),r=[],l=[],d=[];for(const e of c)try{const t=e.src||e.getAttribute("src")||"";t.includes("recaptcha")&&r.push(e),t.includes("gstatic.com/recaptcha")&&l.push(e),t.includes("google.com/recaptcha")&&d.push(e)}catch{continue}const g=document.querySelectorAll('[class*="recaptcha"], [id*="recaptcha"], [class*="g-recaptcha"]');console.log("[CAPTCHA Solver] reCAPTCHA v2 detection:",{hasCheckbox:!!t,hasIframe:!!o,hasContainer:!!i,hasSiteKeyElement:!!a,allRecaptchaIframesCount:r.length,gstaticIframesCount:l.length,googleIframesCount:d.length,recaptchaElementsCount:g.length});let p=null;if("undefined"!=typeof window&&window.grecaptcha)try{const e=document.querySelectorAll("[data-sitekey]");e.length>0&&(p=e[0].getAttribute("data-sitekey"))}catch{}if(!(t||o||i||a||r.length>0||l.length>0||d.length>0||g.length>0))return this.hasRecaptchaScript()&&(console.log("[CAPTCHA Solver] reCAPTCHA script loaded but no elements found yet (may load dynamically)"),n.debug("Script loaded but no elements found",{hasGrecaptcha:"undefined"!=typeof window&&!!window.grecaptcha,scriptCount:document.querySelectorAll('script[src*="recaptcha"]').length})),null;const m=i||a||t||(r.length>0?r[0]:null)||(l.length>0?l[0]:null)||(d.length>0?d[0]:null)||(g.length>0?g[0]:null),f=[t,o,i,a,r.length>0,l.length>0,d.length>0,g.length>0].filter(Boolean).length,C=this.calculateConfidence(f,8);let b=null;i?b=this.getSiteKey(i):a?b=this.getSiteKey(a):p?b=p:g.length>0&&(b=this.getSiteKey(g[0]));const w=o||(r.length>0?r[0]:null)||(l.length>0?l[0]:null)||(d.length>0?d[0]:null);return{type:e.RECAPTCHA_V2,siteKey:b||void 0,element:m,iframe:w,confidence:C,metadata:{version:"v2",hasCheckbox:!!t,hasIframe:!!w,hasContainer:!!i,hasSiteKeyElement:!!a,allRecaptchaIframesCount:r.length,gstaticIframesCount:l.length,googleIframesCount:d.length,recaptchaElementsCount:g.length}}}async detectV3(){const t="undefined"!=typeof window&&void 0!==window.grecaptcha,n=this.findElement(d),o=this.findIframeByDomain("recaptcha/api2/webworker"),i=this.findElement(h);if(!(t||n||o||i))return null;const a=[t,n,o,i].filter(Boolean).length,c=this.calculateConfidence(a,4);let r=null;return i&&(r=this.getSiteKey(i)),{type:e.RECAPTCHA_V3,siteKey:r||void 0,element:i||n||null,iframe:o||null,confidence:c,metadata:{version:"v3",hasGrecaptcha:t,hasBadge:!!n}}}hasRecaptchaScript(){if("undefined"!=typeof window&&window.grecaptcha)return!0;const e=document.querySelectorAll("script[src]");for(const t of e){const e=t.src.toLowerCase();if(e.includes("recaptcha")||e.includes("gstatic.com/recaptcha")||e.includes("google.com/recaptcha"))return!0}return!1}}class E extends r{captchaType=e.HCAPTCHA;selectors=[g,'iframe[src*="hcaptcha.com"]',p];domains=A;async detect(){if(this.hasHCaptchaScript());else if(!this.isApplicable())return null;const t="undefined"!=typeof window&&void 0!==window.hcaptcha,n=this.findElement(g),o=this.findIframeByDomain("hcaptcha.com"),i=this.findElement(p);if(!(t||n||o||i))return null;const a=[t,n,o,i].filter(Boolean).length,c=this.calculateConfidence(a,4);let r=null;return i&&(r=this.getSiteKey(i)),{type:e.HCAPTCHA,siteKey:r||void 0,element:i||n||null,iframe:o||null,confidence:c,metadata:{hasHcaptcha:t,hasCheckbox:!!n,hasIframe:!!o}}}hasHCaptchaScript(){if("undefined"!=typeof window&&window.hcaptcha)return!0;const e=document.querySelectorAll("script[src]");for(const t of e){const e=t.src.toLowerCase();if(e.includes("hcaptcha")||e.includes("js.hcaptcha.com"))return!0}return!1}}class T extends r{captchaType=e.TURNSTILE;selectors=[m,'iframe[src*="challenges.cloudflare.com"]'];domains=v;async detect(){if(!this.isApplicable())return null;const t="undefined"!=typeof window&&void 0!==window.turnstile,n=this.findElement(m),o=this.findIframeByDomain("challenges.cloudflare.com");if(!t&&!n&&!o)return null;const i=[t,n,o].filter(Boolean).length,a=this.calculateConfidence(i,3);let c=null;return n&&(c=this.getSiteKey(n)),{type:e.TURNSTILE,siteKey:c||void 0,element:n||null,iframe:o||null,confidence:a,metadata:{hasTurnstile:t,hasWidget:!!n,hasIframe:!!o}}}}class k extends r{captchaType=e.IMAGE_CAPTCHA;selectors=[f,C,b];domains=[];async detect(){const t=document.querySelector('.g-recaptcha, [data-sitekey], .recaptcha-checkbox, iframe[src*="recaptcha"]'),n=document.querySelector('.h-captcha, .hcaptcha-box, iframe[src*="hcaptcha"]'),o=document.querySelector('.cf-turnstile, iframe[src*="challenges.cloudflare.com"]');if(t||n||o)return null;if(!this.isApplicable())return null;const i=this.findElement(f),a=this.findElement(C),c=this.findElement(b);if(!i&&!a&&!c)return null;let r=!1;if(i){const e=i.getAttribute("alt")?.toLowerCase()||"",t=i.getAttribute("src")?.toLowerCase()||"",n=i.classList.toString().toLowerCase(),o=i.getAttribute("id")?.toLowerCase()||"";if(t.includes("recaptcha")||t.includes("hcaptcha")||t.includes("gstatic.com")||n.includes("recaptcha")||n.includes("hcaptcha"))return null;if(r=e.includes("captcha")||e.includes("verification")||e.includes("security")||t.includes("captcha")||t.includes("verify")||n.includes("captcha")||n.includes("verify")||o.includes("captcha")||o.includes("verify"),!r&&a){const e=i.getBoundingClientRect(),t=a.getBoundingClientRect();Math.abs(e.top-t.top)+Math.abs(e.left-t.left)<300&&(r=!0)}}const s=a,l=s&&(s.name?.toLowerCase().includes("captcha")||s.id?.toLowerCase().includes("captcha")||s.name?.toLowerCase().includes("code")||s.id?.toLowerCase().includes("code")||s.name?.toLowerCase().includes("verify")||s.id?.toLowerCase().includes("verify"));if(!r&&!l&&!c)return null;const d=[i,a,c].filter(Boolean).length,u=this.calculateConfidence(d,3)*(r?1:.7);return{type:e.IMAGE_CAPTCHA,element:c||i||a||null,iframe:null,confidence:u,metadata:{hasImage:!!i,hasInput:!!a,isCaptchaImage:r}}}}const P={recaptcha:()=>new y,hcaptcha:()=>new E,turnstile:()=>new T,image:()=>new k};class S{detectors=new Map;detectorFactories=P;constructor(){}getDetector(e){if(this.detectors.has(e))return this.detectors.get(e);const t=this.detectorFactories[e];if(!t)throw new Error(`Unknown detector type: ${e}`);const n=t();return this.detectors.set(e,n),n}async detectAll(){const t=[],o=["recaptcha","hcaptcha","turnstile","image"];for(const e of o)try{const o=this.getDetector(e),i=await o.detect();i&&(i.confidence>=.3?(n.debug("Adding detection to results",{type:i.type,confidence:i.confidence}),t.push(i)):n.debug("Low confidence detection rejected",{type:i.type,confidence:i.confidence,detector:e}))}catch(i){n.error(`Error detecting CAPTCHA with ${e}`,{error:i instanceof Error?i.message:"Unknown error"})}return t.sort((t,n)=>{const o=t=>t===e.RECAPTCHA_V2||t===e.RECAPTCHA_V3?4:t===e.HCAPTCHA?3:t===e.TURNSTILE?2:t===e.IMAGE_CAPTCHA?1:0,i=o(n.type)-o(t.type);return 0!==i?i:n.confidence-t.confidence})}async detectType(t){let o=null;if(t===e.RECAPTCHA_V2||t===e.RECAPTCHA_V3?o="recaptcha":t===e.HCAPTCHA?o="hcaptcha":t===e.TURNSTILE?o="turnstile":t===e.IMAGE_CAPTCHA&&(o="image"),!o)return null;try{const e=this.getDetector(o);return await e.detect()}catch(i){return n.error(`Error detecting ${t}`,{error:i instanceof Error?i.message:"Unknown error"}),null}}}function H(e,t){const n=Math.floor(Math.random()*(t-e+1))+e;return o=n,new Promise(e=>setTimeout(e,o));var o}function I(e,t,n,o,i){const a=1-e,c=e*e,r=a*a;return r*a*t+3*r*e*n+3*a*c*o+c*e*i}async function x(e,t={}){const n=t.moveMouse??!0,o=t.hoverDuration??100*Math.random()+50,i=t.clickDelay??50*Math.random()+10;n&&await async function(e,t={}){const n=e.getBoundingClientRect(),o=n.left+n.width/2,i=n.top+n.height/2,a=t.startX??window.innerWidth/2,c=t.startY??window.innerHeight/2,r=t.duration??300*Math.random()+200,s=t.steps??20,{cp1x:l,cp1y:d,cp2x:u,cp2y:h}=function(e,t,n,o){const i=Math.sqrt(Math.pow(n-e,2)+Math.pow(o-t,2)),a=.3*Math.random()+.2;return{cp1x:e+.25*(n-e)+(Math.random()-.5)*i*a,cp1y:t+.25*(o-t)+(Math.random()-.5)*i*a,cp2x:e+.75*(n-e)+(Math.random()-.5)*i*a,cp2y:t+.75*(o-t)+(Math.random()-.5)*i*a}}(a,c,o,i),g=r/s;for(let p=0;p<=s;p++){const t=p/s,n=I(t,a,l,u,o),r=I(t,c,d,h,i),m=2*(Math.random()-.5),f=2*(Math.random()-.5),C=new MouseEvent("mousemove",{view:window,bubbles:!0,cancelable:!0,clientX:n+m,clientY:r+f});e.dispatchEvent(C),p<s&&await new Promise(e=>setTimeout(e,g))}}(e),await async function(e,t=100){const n=new MouseEvent("mouseenter",{view:window,bubbles:!0,cancelable:!0}),o=new MouseEvent("mouseover",{view:window,bubbles:!0,cancelable:!0});e.dispatchEvent(n),e.dispatchEvent(o),await new Promise(e=>setTimeout(e,t))}(e,o),await new Promise(e=>setTimeout(e,i));const a=new MouseEvent("mousedown",{view:window,bubbles:!0,cancelable:!0,button:0});e.dispatchEvent(a),await new Promise(e=>setTimeout(e,20*Math.random()+10));const c=new MouseEvent("mouseup",{view:window,bubbles:!0,cancelable:!0,button:0});e.dispatchEvent(c),await new Promise(e=>setTimeout(e,20*Math.random()+10));const r=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0,button:0});e.dispatchEvent(r)}function R(){try{if("undefined"==typeof chrome)return!1;if(void 0===chrome.runtime)return!1;try{const e=chrome.runtime.id;return"string"==typeof e&&e.length>0}catch(e){return!1}}catch(t){return!1}}function L(){try{return window.self===window.top}catch{return!1}}function D(e){return new Promise((t,n)=>{try{if(!R())return void n(new Error("Extension runtime is not available"));chrome.runtime.sendMessage(e,e=>{if(chrome.runtime.lastError){const e=chrome.runtime.lastError.message||"Unknown error";return void(e.includes("Extension context invalidated")||e.includes("message port closed")?n(new Error("Extension was reloaded. Please refresh the page.")):n(new Error(e)))}t(e)})}catch(o){o instanceof Error&&(o.message.includes("Extension context invalidated")||o.message.includes("message port closed"))?n(new Error("Extension was reloaded. Please refresh the page.")):n(o)}})}class M{detector;observer=null;isEnabled=!1;isProcessing=!1;lastDetectionTime=0;solvingCaptchaId=null;MIN_DETECTION_INTERVAL=5e3;RUNTIME_CHECK_INTERVAL=5e3;PERIODIC_CHECK_INTERVAL=5e3;constructor(){this.detector=new S,this.init()}async init(){try{console.log("[CAPTCHA Solver] init() called"),console.log("[CAPTCHA Solver] isMainFrame():",L());const e={hasChrome:"undefined"!=typeof chrome,hasRuntime:"undefined"!=typeof chrome&&void 0!==chrome.runtime,hasId:"undefined"!=typeof chrome&&void 0!==chrome.runtime&&void 0!==chrome.runtime.id,url:window.location.href};if(console.log("[CAPTCHA Solver] Runtime check:",e),console.log("[CAPTCHA Solver] isRuntimeAvailable():",R()),!L())return console.warn("[CAPTCHA Solver] Skipping: not in main frame (likely in iframe)"),void n.debug("Skipping initialization: not in main frame");if(!R())return console.warn("[CAPTCHA Solver] Skipping: runtime not available",e),console.warn("[CAPTCHA Solver] This may be normal on some pages (chrome://, extension://, or localhost health pages)"),void n.debug("Skipping initialization: runtime not available",e);console.log("[CAPTCHA Solver] Runtime available, continuing initialization...");const i=await t.getConfig();this.isEnabled=i.enabled&&i.autoSolve,n.setEnabled(!0),console.log("[CAPTCHA Solver] Extension initialized on page:",window.location.href),n.info("Content script initialized",{url:window.location.href,enabled:i.enabled,autoSolve:i.autoSolve,isEnabled:this.isEnabled}),i.autoSolve||n.warn("Auto-solve is disabled in settings. Enable it to automatically solve CAPTCHAs."),i.enabled||n.warn("Extension is disabled in settings. Enable it to use CAPTCHA solver."),chrome.storage.onChanged.addListener(e=>{if(e.extension_config){const t=e.extension_config.newValue;if(t){const e=this.isEnabled;this.isEnabled=t.enabled&&t.autoSolve,n.setEnabled(t.advanced?.enableLogging||!1),n.info("Configuration updated",{enabled:this.isEnabled}),o.clear(),this.isEnabled&&!e?this.startDetection():!this.isEnabled&&e&&this.stopDetection()}}}),chrome.runtime.onMessage.addListener((e,t,n)=>(this.handleMessage(e,n),!0)),this.startRuntimeMonitoring(),this.startDetection(),console.log("[CAPTCHA Solver] Detection started. Extension is",this.isEnabled?"ENABLED":"DISABLED")}catch(e){console.error("[CAPTCHA Solver] Initialization error:",e),n.error("Content script initialization failed",{error:e instanceof Error?e.message:"Unknown error"})}}handleMessage(e,t){switch(e.type){case i.DETECT_CAPTCHA:this.handleDetectCaptcha(t);break;case i.SOLVE_CAPTCHA:this.handleSolveCaptcha(e,t);break;case i.INJECT_TOKEN:this.handleInjectToken(e),t({success:!0});break;case i.CAPTCHA_SOLVED:const n=e;if((n.result||n.token||n.success)&&(console.log("[CAPTCHA Solver] [Content] Received CAPTCHA_SOLVED message via tabs.sendMessage",{success:n.result?.success||n.success,hasToken:!!n.result?.token||!!n.token,error:n.result?.error||n.error}),n.result?.token||n.token)){const e=n.result?.token||n.token||"",t=o.get(window.location.href);t&&t.length>0&&this.handleInjectToken({detection:t[0],token:e})}t({success:!0});break;default:t({success:!1,error:"Unknown message type"})}}handleInjectToken(t){const{detection:o,token:i}=t;if(console.log("[CAPTCHA Solver] [Content] handleInjectToken called",{type:o.type,tokenLength:i?.length||0,hasToken:!!i&&i.length>0}),!i||0===i.length)return console.error("[CAPTCHA Solver] [Content] Empty token provided!"),void n.error("Empty token provided for injection",{type:o.type});try{switch(o.type){case e.RECAPTCHA_V2:case e.RECAPTCHA_V3:console.log("[CAPTCHA Solver] [Content] Injecting reCAPTCHA token..."),this.injectRecaptchaToken(i);break;case e.HCAPTCHA:console.log("[CAPTCHA Solver] [Content] Injecting hCaptcha token..."),this.injectHCaptchaToken(i);break;case e.TURNSTILE:console.log("[CAPTCHA Solver] [Content] Injecting Turnstile token..."),this.injectTurnstileToken(i);break;case e.IMAGE_CAPTCHA:console.log("[CAPTCHA Solver] [Content] Injecting Image CAPTCHA token..."),this.injectImageCaptchaToken(i,o);break;default:console.warn("[CAPTCHA Solver] [Content] Token injection not implemented for type:",o.type)}}catch(a){console.error("[CAPTCHA Solver] [Content] Error injecting token:",a),n.error("Error injecting token",{error:a instanceof Error?a.message:"Unknown error",type:o.type})}}injectRecaptchaToken(e){console.log("[CAPTCHA Solver] [Content] injectRecaptchaToken called",{tokenLength:e.length,tokenPrefix:e.substring(0,20)+"..."}),n.info("Injecting reCAPTCHA token automatically");const t=document.querySelector('textarea[name="g-recaptcha-response"]');if(console.log("[CAPTCHA Solver] [Content] Textarea found:",!!t),t){console.log("[CAPTCHA Solver] [Content] Setting token in textarea..."),t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0})),t.dispatchEvent(new Event("keyup",{bubbles:!0,cancelable:!0})),t.dispatchEvent(new Event("keydown",{bubbles:!0,cancelable:!0})),Object.defineProperty(t,"value",{value:e,writable:!0,configurable:!0});const o=t.value;console.log("[CAPTCHA Solver] [Content] Token set in textarea",{expectedLength:e.length,actualLength:o.length,matches:o===e}),n.info("Token set in textarea",{tokenLength:e.length})}else console.warn("[CAPTCHA Solver] [Content] Textarea not found, trying alternative methods"),n.warn("Textarea not found, trying alternative methods");const o=window.grecaptcha;if(console.log("[CAPTCHA Solver] [Content] grecaptcha available:",!!o),o){const o=document.querySelector("[data-callback]"),i=o?.getAttribute("data-callback");if(console.log("[CAPTCHA Solver] [Content] Callback found:",i),i){const o=window[i];if("function"==typeof o){console.log("[CAPTCHA Solver] [Content] Calling existing callback:",i),n.info("Calling reCAPTCHA callback",{callback:i});try{o(e),console.log("[CAPTCHA Solver] [Content] ✓ Callback executed successfully")}catch(r){console.error("[CAPTCHA Solver] [Content] Error calling callback:",r),n.warn("Error calling callback",{error:r instanceof Error?r.message:"Unknown"})}}else console.log("[CAPTCHA Solver] [Content] Creating callback function:",i),n.info("Creating callback function",{callback:i}),window[i]=e=>{console.log("[CAPTCHA Solver] [Content] Created callback executed"),n.debug("Callback executed",{callback:i}),t&&(t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})))},console.log("[CAPTCHA Solver] [Content] Calling created callback with token"),window[i](e)}const a=t?.closest("form");a&&(console.log("[CAPTCHA Solver] [Content] Found form, triggering events"),n.debug("Found form, triggering events"),a.dispatchEvent(new Event("submit",{bubbles:!0,cancelable:!0})),a.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0})))}const i=document.querySelectorAll("textarea");console.log("[CAPTCHA Solver] [Content] Found textareas:",i.length);for(const s of i)s.name&&s.name.includes("recaptcha")&&(console.log("[CAPTCHA Solver] [Content] Setting token in additional textarea:",s.name),s.value=e,s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),n.debug("Token set in additional textarea",{name:s.name}));const a=document.querySelector('textarea[name="g-recaptcha-response"]'),c=a?.value||"";console.log("[CAPTCHA Solver] [Content] Final token verification:",{textareaExists:!!a,tokenLength:c.length,tokenMatches:c===e}),n.info("Token injection completed",{tokenLength:e.length,finalTokenLength:c.length})}injectHCaptchaToken(e){n.info("Injecting hCaptcha token automatically");const t=document.querySelector('textarea[name="h-captcha-response"]');if(t&&(t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0})),t.dispatchEvent(new Event("keyup",{bubbles:!0,cancelable:!0})),Object.defineProperty(t,"value",{value:e,writable:!0,configurable:!0}),n.info("Token set in textarea",{tokenLength:e.length})),window.hcaptcha){const t=document.querySelector("[data-callback]"),i=t?.getAttribute("data-callback");if(i){const t=window[i];if("function"==typeof t){n.info("Calling hCaptcha callback",{callback:i});try{t(e)}catch(o){n.warn("Error calling callback",{error:o instanceof Error?o.message:"Unknown"})}}else window[i]=e=>{n.debug("hCaptcha callback executed")},window[i](e)}}n.info("hCaptcha token injection completed")}injectTurnstileToken(e){n.info("Injecting Turnstile token automatically");const t=document.querySelector('input[name="cf-turnstile-response"]');if(t&&(t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0})),t.dispatchEvent(new Event("keyup",{bubbles:!0,cancelable:!0})),Object.defineProperty(t,"value",{value:e,writable:!0,configurable:!0}),n.info("Token set in input",{tokenLength:e.length})),window.turnstile){const t=document.querySelector("[data-callback]"),i=t?.getAttribute("data-callback");if(i){const t=window[i];if("function"==typeof t){n.info("Calling Turnstile callback",{callback:i});try{t(e)}catch(o){n.warn("Error calling callback",{error:o instanceof Error?o.message:"Unknown"})}}else window[i]=e=>{n.debug("Turnstile callback executed")},window[i](e)}}n.info("Turnstile token injection completed")}injectImageCaptchaToken(e,t){if(n.info("Injecting Image CAPTCHA token automatically",{tokenLength:e.length}),!e||0===e.length)return void n.warn("Empty token provided for image CAPTCHA");const o=['input[name*="captcha"]','input[id*="captcha"]','input[type="text"]','input[type="number"]','input[name*="code"]','input[id*="code"]','input[name*="answer"]','input[id*="answer"]'];let i=null;if(t.element){const e=t.element.closest("form, div, section")||t.element;for(const t of o)if(i=e.querySelector(t),i){n.info("Found input near detection element",{selector:t});break}}if(!i)for(const a of o){const e=document.querySelectorAll(a);for(const t of e)if(null!==t.offsetParent&&t.closest('[class*="captcha"], [id*="captcha"], [class*="code"], [id*="code"]')){i=t,n.info("Found visible input near captcha element",{selector:a});break}if(i)break;if(!i&&e.length>0)for(const t of e)if(null!==t.offsetParent){i=t,n.info("Found first visible input",{selector:a});break}if(i)break}if(i)i.value=e,i.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),i.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0})),i.dispatchEvent(new Event("keyup",{bubbles:!0,cancelable:!0})),i.dispatchEvent(new Event("keydown",{bubbles:!0,cancelable:!0})),i.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0})),Object.defineProperty(i,"value",{value:e,writable:!0,configurable:!0}),i.focus(),n.info("Token set in input field",{tokenLength:e.length,inputName:i.name,inputId:i.id});else{n.warn("Input field not found for image CAPTCHA token injection");const t=document.querySelector('input[type="text"]');t&&(t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),n.info("Token set in fallback input field"))}n.info("Image CAPTCHA token injection completed")}async handleDetectCaptcha(e){try{e({success:!0,data:await this.detector.detectAll()})}catch(t){e({success:!1,error:t instanceof Error?t.message:"Unknown error"})}}async handleSolveCaptcha(e,t){if(e.type===i.SOLVE_CAPTCHA)try{const n=await this.solveCaptcha(e.detection);t({success:n.success,data:n})}catch(n){t({success:!1,error:n instanceof Error?n.message:"Unknown error"})}else t({success:!1,error:"Invalid message type"})}startDetection(){if(!document.body){const e=new MutationObserver(()=>{document.body&&(e.disconnect(),this.startDetection())});return void e.observe(document.documentElement,{childList:!0,subtree:!1})}a.setTimeout("initial-detection",()=>{this.detectAndSolve()},1e3),a.setInterval("periodic-check",()=>{this.isEnabled?this.isProcessing||this.detectAndSolve():a.clearInterval("periodic-check")},this.PERIODIC_CHECK_INTERVAL);const e=function(e){let t=null;return function(...n){t&&clearTimeout(t),t=setTimeout(()=>{t=null,e(...n)},1e3)}}(()=>{!this.isProcessing&&this.isEnabled&&this.detectAndSolve()});this.observer=new MutationObserver(()=>{e()}),this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","data-sitekey","src"]}),n.info("Detection started",{hasObserver:!!this.observer,bodyReady:!!document.body})}stopDetection(){this.observer&&(this.observer.disconnect(),this.observer=null),a.clearInterval("periodic-check"),a.clearInterval("runtime-check"),a.clearTimeout("initial-detection")}async detectAndSolve(){if(this.isProcessing)return void n.debug("Detection already in progress, skipping");if(!this.isEnabled)return void n.debug("Detection disabled, skipping",{isEnabled:this.isEnabled});const e=Date.now();if(e-this.lastDetectionTime<this.MIN_DETECTION_INTERVAL)n.debug("Detection throttled",{timeSinceLast:e-this.lastDetectionTime,minInterval:this.MIN_DETECTION_INTERVAL});else{this.isProcessing=!0,this.lastDetectionTime=e,n.debug("Starting detection cycle"),console.log("[CAPTCHA Solver] Starting detection cycle...");try{if(!R()){const e={hasChrome:"undefined"!=typeof chrome,hasRuntime:"undefined"!=typeof chrome&&void 0!==chrome.runtime,hasId:"undefined"!=typeof chrome&&void 0!==chrome.runtime&&void 0!==chrome.runtime.id,url:window.location.href,isMainFrame:L()};return console.warn("[CAPTCHA Solver] Runtime unavailable, skipping detection",e),n.debug("Extension runtime temporarily unavailable, skipping this detection cycle",e),a.clearInterval("periodic-check"),n.debug("Stopped periodic detection due to runtime unavailability"),void(!window.location.href.includes("/health")&&window.location.href.includes("localhost:3001"))}let e;0===a.getIntervalCount()&&this.isEnabled&&(n.debug("Runtime available again, restarting periodic detection"),a.setInterval("periodic-check",()=>{this.isEnabled?!this.isProcessing&&R()&&this.detectAndSolve():a.clearInterval("periodic-check")},this.PERIODIC_CHECK_INTERVAL));try{e=await t.getConfig()}catch(i){const e=i instanceof Error?i.message:"Unknown error";if(e.includes("Extension context invalidated")||e.includes("Extension was reloaded"))return n.warn("Extension context invalidated during config fetch, stopping detection"),this.isEnabled=!1,void this.stopDetection();throw i}if(!this.isUrlAllowed(window.location.href,e))return void n.debug("URL not allowed (whitelist/blacklist)",{url:window.location.href});const r=o.get(window.location.href);if(r){n.debug("Using cached detection",{count:r.length});for(const t of r)if(this.isCaptchaTypeEnabled(t.type,e)&&(n.info("CAPTCHA found in cache",{type:t.type,confidence:t.confidence,siteKey:t.siteKey}),e.autoSolve&&e.enabled)){n.debug("Auto-solving cached CAPTCHA",{type:t.type});try{await this.solveCaptcha(t)}catch(i){const e=i instanceof Error?i.message:"Unknown error";if(e.includes("Extension context invalidated")||e.includes("Extension was reloaded")||e.includes("message port closed"))return n.warn("Extension context invalidated during solve, stopping"),this.isEnabled=!1,this.isProcessing=!1,void this.stopDetection();n.error("Error solving cached CAPTCHA",{type:t.type,error:e})}}return}n.debug("Starting CAPTCHA detection...");const s=await c(()=>this.detector.detectAll(),{maxAttempts:2,delay:500,onRetry:(e,t)=>{n.warn("Detection retry",{attempt:e,error:t.message})}});n.debug(`Detection completed. Found ${s.length} CAPTCHA(s)`),console.log(`[CAPTCHA Solver] Detection completed. Found ${s.length} CAPTCHA(s)`),s.length>0&&(o.set(window.location.href,s),s.forEach(e=>{console.log(`[CAPTCHA Solver] Found: ${e.type} (confidence: ${e.confidence})`)}));for(const t of s){if(!this.isCaptchaTypeEnabled(t.type,e)){n.debug("CAPTCHA type disabled",{type:t.type});continue}const o=`${t.type}-${t.siteKey||"no-sitekey"}-${t.element?.getAttribute("data-sitekey")||"no-element"}`;if(this.solvingCaptchaId!==o)if(console.log("[CAPTCHA Solver] CAPTCHA detected:",t.type,"confidence:",t.confidence),n.info("CAPTCHA detected",{type:t.type,confidence:t.confidence,siteKey:t.siteKey}),this.notifyDetection(t),e.autoSolve&&e.enabled){console.log("[CAPTCHA Solver] Starting to solve CAPTCHA:",t.type),n.info("Auto-solving CAPTCHA",{type:t.type});try{(await this.solveCaptcha(t)).success?(console.log("[CAPTCHA Solver] ✓ CAPTCHA solved successfully:",t.type),n.info("CAPTCHA solved successfully",{type:t.type})):(console.warn("[CAPTCHA Solver] ✗ CAPTCHA solving failed:",t.type),n.warn("CAPTCHA solving failed",{type:t.type}))}catch(i){const e=i instanceof Error?i.message:"Unknown error";if(e.includes("Extension context invalidated")||e.includes("Extension was reloaded")||e.includes("message port closed"))return n.warn("Extension context invalidated during auto-solve, stopping"),this.isEnabled=!1,this.isProcessing=!1,void this.stopDetection();n.error("Error during auto-solve",{type:t.type,error:e})}finally{this.solvingCaptchaId===o&&(this.solvingCaptchaId=null)}}else n.debug("Auto-solve skipped",{enabled:e.enabled,autoSolve:e.autoSolve,type:t.type});else n.debug("CAPTCHA already being solved, skipping",{type:t.type,captchaId:o})}0===s.length&&n.debug("No CAPTCHAs detected on this page")}catch(i){const e=i instanceof Error?i.message:"Unknown error";if(e.includes("Extension context invalidated")||e.includes("Extension was reloaded")||e.includes("message port closed"))return n.warn("Extension context invalidated, stopping detection (will auto-restart when available)",{error:e}),this.isEnabled=!1,this.isProcessing=!1,void this.stopDetection();n.error("Error in detectAndSolve",{error:e})}finally{this.isProcessing=!1}}}async solveCaptcha(o){try{if(!R()||!L())return n.warn("Cannot solve CAPTCHA: runtime not available or not in main frame"),{success:!1};let a;(await t.getConfig()).hideUI&&o.element&&this.hideCaptchaUI(o.element),o.type!==e.RECAPTCHA_V2&&o.type!==e.HCAPTCHA||(console.log("[CAPTCHA Solver] Clicking checkbox for:",o.type),await this.autoClickCheckbox(o)),o.type===e.IMAGE_CAPTCHA&&o.element&&(a=await this.extractImageBase64(o.element)),console.log("[CAPTCHA Solver] Sending solve request to background service..."),console.log("[CAPTCHA Solver] Request details:",{type:o.type,siteKey:o.siteKey?.substring(0,10)+"...",hasImageData:!!a});const r=await c(()=>(console.log("[CAPTCHA Solver] Attempting to send message to background service..."),D({type:i.SOLVE_CAPTCHA,detection:{...o,imageBase64:a},timestamp:Date.now()})),{maxAttempts:2,delay:1e3,onRetry:(e,t)=>{console.warn(`[CAPTCHA Solver] Solve request retry ${e}:`,t.message),n.warn("Solve request retry",{attempt:e,error:t.message,type:o.type})}});if(console.log("[CAPTCHA Solver] Response received from background service:",{success:r?.success,hasData:!!r?.data,hasToken:!!r?.data?.token,tokenLength:r?.data?.token?.length||0,error:r?.error}),r?.success){console.log("[CAPTCHA Solver] ✓ Solve request successful");const e=r?.data;e?.token?(console.log("[CAPTCHA Solver] Token received in response, injecting..."),this.handleInjectToken({detection:o,token:e.token})):console.warn("[CAPTCHA Solver] No token in response data")}else console.warn("[CAPTCHA Solver] ✗ Solve request failed:",r?.error||"Unknown error");return{success:r?.success||!1}}catch(a){return n.error("Error solving CAPTCHA",{error:a instanceof Error?a.message:"Unknown error",type:o.type}),{success:!1}}}async autoClickCheckbox(e){if(e.element)try{const e=await t.getConfig(),n=await function(e,t=1e4,n=document){return new Promise(o=>{const i=n.querySelector(e);if(i)return void o(i);const a=new MutationObserver((t,i)=>{const a=n.querySelector(e);a&&(i.disconnect(),o(a))});a.observe(n,{childList:!0,subtree:!0}),setTimeout(()=>{a.disconnect(),o(null)},t)})}(".recaptcha-checkbox, .hcaptcha-box",5e3);n&&function(e){if(!e)return!1;const t=window.getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility||"0"===t.opacity)return!1;const n=e.getBoundingClientRect();return n.width>0&&n.height>0}(n)&&(e.advanced.humanLikeBehavior&&(await async function(){for(let e=0;e<Math.floor(3*Math.random())+1;e++){const e=Math.random()*window.innerWidth,t=Math.random()*window.innerHeight,n=new MouseEvent("mousemove",{view:window,bubbles:!0,cancelable:!0,clientX:e,clientY:t});document.dispatchEvent(n),await H(100,300)}if(Math.random()<.5){const e=200*Math.random()-100;window.scrollBy({top:e,behavior:"smooth"}),await H(200,500)}}(),await async function(e=500,t=2e3){const n=Math.floor(Math.random()*(t-e+1))+e;await H(.5*n,n)}(300,800)),await function(e,t=.2){const n=e*t;return H(e-n,e+n)}(e.advanced.clickDelay),e.advanced.humanLikeBehavior&&e.advanced.mouseMovement?await x(n,{moveMouse:!0,hoverDuration:100*Math.random()+50,clickDelay:50*Math.random()+10}):n.click())}catch(o){n.error("Error auto-clicking checkbox",{error:o instanceof Error?o.message:"Unknown error"})}}hideCaptchaUI(e){e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",e.style.position="absolute",e.style.left="-9999px"}async extractImageBase64(e){try{let a=null;const c=['img[src*="captcha"]','img[alt*="captcha"]','img[alt*="CAPTCHA"]',"img.captcha-image",'img[class*="captcha"]','img[id*="captcha"]',"img"];for(const t of c)if(a=e.querySelector(t),a){n.debug("Found image with selector",{selector:t});break}if(!a){let t=e;for(let e=0;e<3&&t;e++)if(t=t.parentElement,t){for(const o of c)if(a=t.querySelector(o),a){n.debug("Found image in parent container",{selector:o,level:e+1});break}if(a)break}}if(!a){const t=document.querySelectorAll("img");for(const o of t){const t=o.getAttribute("alt")?.toLowerCase()||"",i=o.getAttribute("src")?.toLowerCase()||"",c=o.classList.toString().toLowerCase();if((t.includes("captcha")||i.includes("captcha")||c.includes("captcha"))&&!i.includes("recaptcha")&&!i.includes("hcaptcha")&&!i.includes("gstatic.com")){const t=o.getBoundingClientRect(),i=e.getBoundingClientRect(),c=Math.abs(t.top-i.top)+Math.abs(t.left-i.left);if(c<500){a=o,n.debug("Found captcha image near element",{distance:c});break}}}}if(!a)return void n.warn("No image found in CAPTCHA element or nearby");const r=document.createElement("canvas"),s=r.getContext("2d");if(!s)return void n.error("Failed to get canvas context");await new Promise((e,t)=>{a.complete&&a.naturalWidth>0?e():(a.onload=()=>e(),a.onerror=()=>t(new Error("Failed to load image")),setTimeout(()=>t(new Error("Image load timeout")),5e3))});const l=a.naturalWidth||a.width||a.clientWidth,d=a.naturalHeight||a.height||a.clientHeight;if(0===l||0===d)return void n.error("Image has zero dimensions",{width:l,height:d});r.width=l,r.height=d;try{s.drawImage(a,0,0)}catch(t){n.warn("Direct canvas draw failed (possibly CORS), trying alternative method",{error:t instanceof Error?t.message:"Unknown error"});try{const e=await fetch(a.src),t=await e.blob();if(void 0!==window.createImageBitmap){const e=await window.createImageBitmap(t);r.width=e.width,r.height=e.height,s.drawImage(e,0,0),e.close()}else{const e=URL.createObjectURL(t),n=new Image;await new Promise((t,o)=>{n.onload=t,n.onerror=o,n.src=e,setTimeout(()=>o(new Error("Image load timeout")),5e3)}),r.width=n.width,r.height=n.height,s.drawImage(n,0,0),URL.revokeObjectURL(e)}}catch(o){n.error("Alternative image fetch also failed",{error:o instanceof Error?o.message:"Unknown error"}),s.drawImage(a,0,0)}}const u=r.toDataURL("image/png");if(!u||u.length<100)return void n.error("Generated base64 is too short or empty");try{const e=await async function(e,n={}){const{maxWidth:o=800,maxHeight:i=600,quality:a=.8,format:c="jpeg"}=n;return new Promise((n,r)=>{const s=new Image;let l=null;s.onload=()=>{l&&(clearTimeout(l),l=null);try{const e=document.createElement("canvas");let l=s.width,d=s.height;l>o&&(d=d*o/l,l=o),d>i&&(l=l*i/d,d=i),e.width=l,e.height=d;const u=e.getContext("2d");if(!u)return void r(new Error("Failed to get canvas context"));u.drawImage(s,0,0,l,d);let h,g="image/jpeg";"webp"===c?g="image/webp":"png"===c&&(g="image/png");try{h=e.toDataURL(g,a),(!h||h.length<100)&&(h=e.toDataURL("image/jpeg",a))}catch(t){h=e.toDataURL("image/jpeg",a)}n(h)}catch(t){r(t instanceof Error?t:new Error("Unknown error"))}},s.onerror=()=>{l&&(clearTimeout(l),l=null),r(new Error("Failed to load image"))},l=setTimeout(()=>{l=null,r(new Error("Image load timeout"))},1e4),s.src=e})}(u,{maxWidth:800,maxHeight:600,quality:.8,format:function(){const e=document.createElement("canvas");return e.width=1,e.height=1,0===e.toDataURL("image/webp").indexOf("data:image/webp")}()?"webp":"jpeg"});return n.info("Image extracted and compressed successfully",{width:l,height:d,originalSize:u.length,compressedSize:e.length,compressionRatio:(100*(1-e.length/u.length)).toFixed(1)+"%"}),e}catch(i){return n.warn("Image compression failed, using uncompressed",{error:i instanceof Error?i.message:"Unknown error"}),u}}catch(t){return void n.error("Failed to extract image base64",{error:t instanceof Error?t.message:"Unknown error"})}}isUrlAllowed(e,t){if(t.blacklist.some(t=>e.includes(t)))return n.debug("URL blocked by blacklist",{url:e,pattern:t.blacklist.find(t=>e.includes(t))}),!1;if(t.whitelist.length>0){const o=t.whitelist.some(t=>e.includes(t));return o||n.debug("URL not in whitelist",{url:e,whitelist:t.whitelist}),o}return!0}isCaptchaTypeEnabled(t,n){switch(t){case e.RECAPTCHA_V2:return n.captchaTypes.recaptchaV2;case e.RECAPTCHA_V3:return n.captchaTypes.recaptchaV3;case e.HCAPTCHA:return n.captchaTypes.hcaptcha;case e.TURNSTILE:return n.captchaTypes.turnstile;case e.IMAGE_CAPTCHA:return n.captchaTypes.imageCaptcha;default:return!1}}notifyDetection(e){R()&&L()&&D({type:i.CAPTCHA_DETECTED,detection:e,timestamp:Date.now()}).catch(e=>{n.debug("Failed to notify detection",{error:e.message})})}startRuntimeMonitoring(){a.setInterval("runtime-check",()=>{if(!R())return n.debug("Runtime temporarily unavailable"),a.clearInterval("periodic-check"),void n.debug("Stopped periodic detection due to runtime unavailability (monitoring)");!this.isEnabled&&R()&&(n.info("Runtime available again, attempting to reinitialize"),this.reinitialize()),this.isEnabled&&0===a.getIntervalCount()&&(n.debug("Runtime available, restarting periodic detection (monitoring)"),a.setInterval("periodic-check",()=>{this.isEnabled?!this.isProcessing&&R()&&this.detectAndSolve():a.clearInterval("periodic-check")},this.PERIODIC_CHECK_INTERVAL))},this.RUNTIME_CHECK_INTERVAL)}async reinitialize(){try{if(!R())return void n.debug("Runtime not available for reinitialization");this.stopDetection(),this.isProcessing=!1,this.lastDetectionTime=0,this.solvingCaptchaId=null;try{const e=await t.getConfig();this.isEnabled=e.enabled&&e.autoSolve,n.setEnabled(e.advanced.enableLogging),n.info("Content script reinitialized after extension reload",{enabled:e.enabled,autoSolve:e.autoSolve,isEnabled:this.isEnabled}),this.isEnabled&&this.startDetection()}catch(e){const t=e instanceof Error?e.message:"Unknown error";t.includes("Extension context invalidated")||t.includes("Extension was reloaded")?(n.debug("Extension still reloading, will retry later"),this.isEnabled=!1):n.error("Error during reinitialization",{error:t})}}catch(e){n.error("Error in reinitialize",{error:e instanceof Error?e.message:"Unknown error"})}}destroy(){this.stopDetection(),a.clearAll(),o.clear(),this.isEnabled=!1,this.isProcessing=!1}}!function(){console.log("[CAPTCHA Solver] Content script file loaded"),console.log("[CAPTCHA Solver] Document ready state:",document.readyState),console.log("[CAPTCHA Solver] Current URL:",window.location.href);const e=console.error,t=console.warn,n=e=>!e.includes("[CAPTCHA Solver]")&&["chrome-extension://invalid","Failed to load resource","net::ERR_FAILED","ERR_FILE_NOT_FOUND","ERR_BLOCKED_BY_CLIENT"].some(t=>e.includes(t));console.error=function(...t){const o=t.join(" ");n(o)||e.apply(console,t)},console.warn=function(...e){const o=e.join(" ");n(o)||t.apply(console,e)};const o=()=>{console.log("[CAPTCHA Solver] Initializing ContentScript...");try{new M}catch(e){console.error("[CAPTCHA Solver] Failed to initialize:",e)}};"loading"===document.readyState?(console.log("[CAPTCHA Solver] Waiting for DOMContentLoaded..."),document.addEventListener("DOMContentLoaded",()=>{console.log("[CAPTCHA Solver] DOMContentLoaded fired"),o()})):(console.log("[CAPTCHA Solver] DOM already ready, initializing immediately"),o())}();
